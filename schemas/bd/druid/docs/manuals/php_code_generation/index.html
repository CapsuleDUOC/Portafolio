<html>
<head>
<title>Documentation for PHP code generated by Druid</title>
</head>
<body>
<h1>Documentation for PHP code generated by Druid</h1>
<p>Druid can generate code for PHP, one class for each entity (table) defined in a druid database model. The classes are PHP 5 objects, and require PHP 5.</p>
<p>Generated PHP objects can range in complexity from simple descriptions of a table structure to persistent objects with CRUD capabilities, associated unit tests, and extensible view classes, along with files to produce the framework for a database driven website.</p>
<h2>Limitations</h2>
<p>Scaling: Generated code is intended to scale up to tens of tables and tens of thousands of records.  It has inherent performance limitations, particularly with the selectDistinct and loadArray methods.  Data types: Not all datatypes may be supported and not all datatypes will have correctly set limits on field lengths, unrecongized datatypes are treated as long text strings.  Datatype support is most complete for MySQL.</p>
<p><strong>Security:</strong> druid_handler.php allows any value from any field in any record for which there is a generated {tablename} class to be returned and edited.  'ajax_handler.php?druid_action=returndistinctjson&amp;table=SENSITIVE_TABLE&amp;field=SENSITIVE_FIELD' will return all unique values in SENSITIVE_FIELD.  You must wrap druid_handler.php with code that authenticates users, and provides a database connection with appropriately restricted rights.   You should not use Druid to build and maintain tables that contain a set of sensitive and public data (e.g. trying to hide a Sensitive class by deleting mention of it from druid_classes.php as a security measure will fail if php code is regenerated and druid_classes.php is overwritten from a druid model that contains the Sensitive entity.</p>
<p>Note: No PHP files generated by druid create a database connection.  You will need to create a database connection and have it in scope when calling any of the generated methods that query the database.  For some drivers and settings, this can work by setting the default database connection parameters in php.ini, but in most cases, you will need to create an appropriate connection to the underlying database (e.g. $connection = mysql_connect('localhost','username','password'); mysql_select_db('{databasename}')).   The name of the variable used to hold the connection handle does not matter, unless you are connecting to an oracle database through OCI8, in which case the generated php code requires it to be named $conn and to be found in $GLOBALS['conn'].</p>
<p>Table Structure: Generated code expects each table to have a surrogate numeric primary key automatically incremented by a sequence (int not null primary key auto_increment in MySQL).  Partial support is available for non-numeric and multiple field primary keys, but it is not complete and has not been tested.</p>
<h2>Options</h2>
<p>Complexity of the generated code is controlled by selecting options on the Generation/Code/PHP tab.</p>
<img src='generation_code_php.png'>

<ul>
<li>Output Directory: The directory into which the generated files will be written.</li>
<li>Extends: The name of the parent class which all generated {tablename} classes will extend.</li>
<li>Name Prefix: A prefix that is added to the beginning of the name of generated {tablename} classes and files.</li>
<li>Name Suffix: A suffix that is added to the end of the name of generated {tablename} classes and files.  Generated class names are {nameprefix}{tablename}{namesuffix} and {nameprefix}{tablename}{namesuffix}View, preserving case.  For example a table named Parts with a name prefix t_ will produce a t_Parts.php file containing class t_Parts and class t_PartsView.<li> 
<li>Generate Field Constants: For each field in the table, generate a constant holding the field length {fieldname}_SIZE. </li>
<li>Generate Field Name Constants:  For each field in the table, generate a constant holding the name of the field in upper case characters {fieldname}. (Select only this option to produce the same output as Druid version 3.9 and below).</li>
<li>Generate Field Variable + Get/Set methods: For each field in the table, generate a private variable, a get{fieldname} method, and a set{fieldname} method.  Also generates factory keyValueSet($fieldname,$value) and keyGet($fieldname) methods that use a $fieldname parameter to select the correct get{fieldname} or set{fieldname} methods.  Also generates PK, PKArray, and numberOfPrimaryKeyFields methods.</li>
<li>Generate Persistence Methods: Generate load(), save(), and delete() methods for each {tablename} class.   Provides CRUD support.</li>
<li>Database Type: {tablename} class uses a database of this type for persistence.  Support for:</li>
<li><ul>
  <li>MySQL 5+ [implemented]</li>
  <li><em>MySQL using PHP's mysqli</em> [planned]</li> 
  <li>Oracle (OCI, Oracle 8+)[mostly implemented, not fully tested]</li>
  <li>Postgresql (8.1+)[implemented, not fully tested]</li>
  <li><em>PHP PDO</em> [planned, awaiting stability in PDO API]</li>
</ul>
</li>
<li>Generate Default View Class:</li>
<li>Generate example ajax edit/save method in view class using the dojo framework.  Dojo is a javascript toolkit for developing rich ajaxian websites.  This option includes a getEditFormDojoView() method in {tablename}View that works with ajax_handler.php and druid_handler.php to allow ajaxian creation, editing, and deletion of a record with form containing validation controls.</li>
<li>Path to dojo: Address (url or path relative to webroot) at which dojo can be found.  Default is url for the public distribution of dojo version 1.1.1 at AOL (http://o.aolcdn.com/dojo/1.1.1/dojo/dojo.xd.js).  The value /dojo/dojo-release-1.1.1/ may be a better choice if you untar the dojo 1.1.1 release within a /dojo directory at the root of the same webserver as the generated PHP code.</li>
<li>Generate unit tests using simpletest framework (simpletest.sourceforge.net)</li>
<li>Generate database level framework files (druid_handler.php, druid_classes.php)</li>
<li>Generate, if they don't exist, example website files (index.php, ajax_handler.php, class_lib.php).  This option generates an example set of website files that work with the other generated files to produce a database driven website.  They are intended as examples of how to use the {tablename} classes and a starting point for customization.</li>
</ul>

<h2>Code generated for entire database</h2>

<h3>druid_classes.php</h3>
<p>Contains include statements to load each generated {tablename}.php file (your code only needs to include_once('druid_classes.php') to include all generated classes for a database.</p>
<p>Declares class database_schema, which lets you pass a tablename as a string and load an appropriate model and view classes for that table.</p>
<ul>
<li>const TABLELIST = list of table names in the database.</li>
<li>hasTable($tablename)  Returns true if $tablename is in TABLELIST.</li>
<li>getClass($tablename)  Returns the model class for a tablename.</li>
<li>getViewClass($tablename)  Returns the view class for a tablename.</li>
</ul>

<h3>druid_handler.php</h3>
<p>Ajax handler for generated classes.  Does not make a database connection, so you will need to wrap this in your own ajax_handler.php 
<h4>actions  ajax_handler.php?action=</h4>
<ul>
<li>save</li>
<li>delete</li>
<li>savesingle</li>
<li>returnfkjson</li>
<li>returndistinctjson</li>
</ul>

<h3>druid_interfaces.php</h3>
<p>Declares interfaces used in {tablename} and {tablename}View classes.</p>
<p>Loaded by include_once('druid_interfaces.php) from within each {tablename}.php file.  You only need to include druid_classes.php in your own code.</p>

<img src='php_generated_classes.png'>

<h4>Interfaces used by generated {tablename} classes.</h4>

<pre>
interface model {
   public function keyValueSet($fieldname,$value); // set the value of a field to specified value for the current instance of model.
   public function keyGet($fieldname); // gets the value of the specified field in the current instance of model.
}
interface loadableModel {
   public function load($pk);  // load data for the record specified by the primary key value $pk into the current instance of model.
   public function isLoaded(); // returns true if model instance contains data loaded from record in table. 
   public function isDirty();  // returns true if model data has changed since instantiation or load. 
   public function loadArrayKeyValueSearch($searchTermArray); // returns an array of models matching the fieldname=value criteria in the searchTermArray
   public function NumberOfPrimaryKeyFields(); // returns the number of fields in the primary key of this table
   public function PKArray(); // return primary key(s) for current record as fieldname=&gt;value array
}
interface saveableModel {
   public function save();    // save changes to current record or add new record to underlying database.
   public function delete();  // delete current record from underlying database.
}
interface summaryModel { 
   public function count();  // returns total number of records in table
   public function keySelectDistinct($fieldname,$startline,$link,$endline,$includecount=false,$orderbycount=false);  // 
                           // return distinct values for $fieldname, if it has an index (if it is in schemaHaveDistinct()).
                           // generic wrapper for selectDistinct{fieldname}() methods.
}
interface tableSchema { 
   public function hasField($fieldname);  // returns true if the model includes a field with a name exactly matching $fieldname.
   public function schemaPK();  // returns array of primary key field names
   public function schemaHaveDistinct();  // returns array of field names for which selectDistinct{fieldname} methods are available.
   public function schemaFields();  // returns array of all field names

}
</pre>
<h4>Interface used by generated {tablename}View classes.</h4>
<pre>
interface viewer {
   public function setModel($aModel);  // specify which instance of model provides the data to be shown in this view.
   public function getDetailsView($includeRelated=true); // display the fields and values of the instance of the model (as a html list in default implementation).
}
</pre>

<h3>test/all_tests.php</h3>
<p>Simpletest (simpletest.sourceforge.net) unit testing harness.  Visit all_tests.php in a web deployment or run <em>php all_tests.php</em> to run unit tests.</p>
<h3>test/druid_test_classes.php</h3>
<p>Simpletest unit tests for generated classes</p>

<h2>Generated for each table</h2>

<h3>{nameprefix}{tablename}{namesuffix}.php</h3>
<h4>class {nameprefix}{tablename}{namesuffix} implements model, loadableModel, saveableModel</h4>
<h4>Or: class {nameprefix}{tablename}{namesuffix} implements model, loadableModel, saveableModel extends {extends}</h4>
<p>Model class for table.  Has private variable for each field in the table, along with get and set methods for each field.<p>
<h5>Generated Methods</h5>

<ul>
<li>{tablename}() constructor [unit test]</li>
<li>isDirty()   [unit test]</li>
<li>isLoaded()</li>
<li>errorMessage()</li>
<li>keyValueSet($fieldname,$value) throws exception</li>
<li>keyGet($fieldname)</li>
<li>get{fieldname}()</li>
<li>set{fieldname}($value) throws exception  [unit test]</li>
<li>PK() [For table with a single field primary key calls get{fieldname} for the primary key field.]</li>
<li>PKArray() [unit test]  [For a table with one or more primary key fields, returns an array of fieldnames and values of the fields in the primary key.]</li>
<li>NumberOfPrimaryKeyFields()</li>
<li>load($pk) throws exception<li>
<li>delete() throws exception</li>
<li>save() [for tables with a single field primary key, assumed to be a surrogate numeric primary key with auto_increment]</li>
<li>save($doinsert=false) [for tables with multiple field primary keys]</li>
<li>count()</li>
<li>loadArrayKeyValueSearch($searchTermArray)</li>
<li>loadArrayByFullText{nameoffulltextindex}</li>
<li>loadArrayBy{fieldname}   For each field with an index.</li>
<li>keySelectDistinctJSON($field,$orderby='ASC')</li>
<li>keySelectAllConcatJSON($orderby='ASC')</li>
<li>selectDistinct{fieldname}  For each field with an index.</li>
<li>hasField($fieldname)</li>
</ul>
<p>If a table has a single field primary key, that primary key is assumed to have its value automatically assigned by the database as 
in a surrogate numeric primary key (i.e. serial, auto_increment, with a sequence).  If a table has a single field primary key, the save function will add a new record
if the primary key for the instance is null, expecting the value for that primary key to be assigned by the database.  If the table has a multiple field
primary key, then save() will require the values for each field in the primary key to be set in the instance in order to either save or insert, and will
only insert a new record if invoked as save(true).  </p>
<h5>Constants</h5>
<ul>
<li>{FIELDNAME}_SIZE</li>
<li>{FIELDNAME}</li>
<li>FIELDLIST</li>
<li>PKLIST</li>
</ul>

<p>The field size of variable size data types is taken from the Size value for that data type in Druid (Data Type tab, Variable Size, "Size" on Var Alias Tab).  If Size is for a decimal number with total length and number of decimal places (e.g. Size = 10,2) then the variable size in PHP is taken as the number before the comma (e.g. 10).</p>
<img src='variable_size_data_tab.png'>
<p>Currently recognized Constant Size field types (Data Type tab, Constant Size, Constant Basic Type tab in Druid) and the sizes they are assigned are listed below.  These names are case insensitive.  BIT, bit, and Bit are all given a size of 1. If a Constant Size data type isn't on this list, a default value of 20 will be used for its size.</p>
<ul>
<li>BIT size = 1 </li>
<li>BOOLEAN size = 1 </li>
<li>TINYINT size = 3 </li>
<li>SMALLINT size = 5 </li>
<li>MEDIUMINT size = 8 </li>
<li>INT size = 10 </li>
<li>INTEGER size = 10 </li>
<li>BIGINT size = 20 </li>
<li>INT size = 10 </li>
<li>DATETIME size = 21  // without timezone </li>
<li>TIMESTAMP size = 21 // without timezone</li>
<li>DATE size = 12 </li>
<li>TIME size = 10</li>
<li>TINYBLOB size = 256 </li>
<li>TINYTEXT size = 256</li>
<li>LONGVARCHAR size = 255</li>
<li>BLOB size = 65536 </li>
<li>TEXT size = 65536</li>
<li>MEDIUMBLOB size = 16777216 </li>
<li>MEDIUMTEXT size = 16777216</li>
<li>LONGBLOB size = 4294967296 </li>
<li>LONGTEXT size = 4294967296</li>
</ul>

<h4>class {tablename}View implements viewer</h4>
<p>Extensible View class for table.  Contains example that can be used to display a record or an ajaxian editing form for an instance of the model class.</p>
<h5>Generated Methods</h5>
<ul>
<li>setModel($aModel)</li>
<li>getDetailsView($includeRelated=true)</li>
<li>getJSON()</li>
<li>getEditFormDojoView($includeRelated=true)</li>
<li>getEditFormView($includeRelated=true)</li>
<li></li>
</ul>

<h3>In test/druid_test_classes.php</h3>
<p>Simpletest unit tests for the constructor, set methods (including raising exceptions for wrong type or overlength values) and primary key values.  Generated methods with unit tests are marked [unit test] above.</p>

<h2>Example supporting code</h2>

<img src='php_supporting_classes.png'>

<p>class_lib.php contains a User class.  The User class assumes a User table in a database with the structure below.  </p> 
<h3>User Table</h3>

<h3>MySQL</h3>
<pre>
CREATE TABLE User
  (
    user_id                    int            primary key not null auto_increment,
    email                      varchar(255)   unique not null,
    password                   varchar(80),
    active                     int            default 1,
    full_name                  varchar(80),
    about                      text,
    date_created               timestamp,
    date_last_updated          datetime,
    date_last_login            datetime,
    failures_since_last_login  int            default 0,
    session_secret             varchar(255)
  )
 TYPE = InnoDB;

CREATE INDEX Useridx1 ON User(email,password,active);
</pre>
<h3>Oracle</h3>
<pre>
CREATE TABLE User
  (
    user_id                    int            not null,
    email                      varchar(255)   unique not null,
    password                   varchar(80),
    active                     int            default 1,
    full_name                  varchar(80),
    about                      text,
    date_created               date,
    date_last_updated          date,
    date_last_login            date,
    failures_since_last_login  int            default 0,
    session_secret             varchar(255),
    primary key(user_id)
  );

CREATE INDEX Useridx1 ON User(email,password,active);
</pre>
<h3>Postgresql</h3>
<pre>

</pre>

<h2>Examples</h2>

<code><span style="color: #000000">
</span>&lt;html&gt;<br />
&lt;head&gt;<br />
&lt;/head&gt;<br />
&lt;body&gt;<br />
&lt;H1&gt;Example use of PHP code generated from Druid.&lt;/H1&gt;<br />
<span style="color: #0000BB">&lt;?php&nbsp;<br />
//&nbsp;This&nbsp;is&nbsp;an&nbsp;example&nbsp;illustrating&nbsp;a&nbsp;few&nbsp;of&nbsp;the&nbsp;ways&nbsp;in&nbsp;which&nbsp;you&nbsp;can&nbsp;use&nbsp;PHP&nbsp;classes&nbsp;<br />
//&nbsp;generated&nbsp;by&nbsp;Druid&nbsp;to&nbsp;produce&nbsp;a&nbsp;database&nbsp;driven&nbsp;website.&nbsp;&nbsp;<br />
<br />
</span><span style="color: #007700">include_once(</span><span style="color: #DD0000">'druid_classes.php'</span><span style="color: #007700">);&nbsp;<br />
</span><span style="color: #FF8000">//&nbsp;*******&nbsp;&nbsp;<br />
//&nbsp;*******&nbsp;&nbsp;You&nbsp;must&nbsp;provide&nbsp;connections.php&nbsp;or&nbsp;a&nbsp;replacement&nbsp;means&nbsp;of<br />
//&nbsp;*******&nbsp;&nbsp;having&nbsp;a&nbsp;database&nbsp;connection&nbsp;in&nbsp;scope&nbsp;before&nbsp;calling&nbsp;methods&nbsp;on&nbsp;generated&nbsp;php&nbsp;tables.<br />
//&nbsp;*******&nbsp;&nbsp;You&nbsp;must&nbsp;also&nbsp;do&nbsp;this&nbsp;in&nbsp;the&nbsp;file&nbsp;ajax_handler.php<br />
//&nbsp;*******&nbsp;&nbsp;<br />
//&nbsp;*******&nbsp;&nbsp;Warning:&nbsp;You&nbsp;must&nbsp;limit&nbsp;the&nbsp;rights&nbsp;of&nbsp;the&nbsp;user&nbsp;in&nbsp;the&nbsp;database&nbsp;for&nbsp;this<br />
//&nbsp;*******&nbsp;&nbsp;connection&nbsp;with&nbsp;appropriate&nbsp;(e.g.&nbsp;select&nbsp;only&nbsp;on&nbsp;this&nbsp;schema&nbsp;only&nbsp;from&nbsp;this&nbsp;host&nbsp;only)&nbsp;privileges.<br />
//&nbsp;*******&nbsp;&nbsp;<br />
</span><span style="color: #007700">@include_once(</span><span style="color: #DD0000">'connections.php'</span><span style="color: #007700">);&nbsp;</span><span style="color: #FF8000">//&nbsp;contains&nbsp;declaration&nbsp;of&nbsp;make_my_database_connection()<br />
</span><span style="color: #007700">@</span><span style="color: #0000BB">$connection&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">make_my_database_connection</span><span style="color: #007700">();&nbsp;<br />
if&nbsp;(!</span><span style="color: #0000BB">$connection</span><span style="color: #007700">)&nbsp;{&nbsp;echo&nbsp;</span><span style="color: #DD0000">'Error:&nbsp;No&nbsp;database&nbsp;connection.'</span><span style="color: #007700">;&nbsp;}&nbsp;<br />
<br />
</span><span style="color: #0000BB">$display&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">preg_replace</span><span style="color: #007700">(</span><span style="color: #DD0000">'/[^a-z]/'</span><span style="color: #007700">,</span><span style="color: #DD0000">''</span><span style="color: #007700">,</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'display'</span><span style="color: #007700">]),</span><span style="color: #0000BB">0</span><span style="color: #007700">,</span><span style="color: #0000BB">20</span><span style="color: #007700">);<br />
switch&nbsp;(</span><span style="color: #0000BB">$display</span><span style="color: #007700">)&nbsp;{<br />
&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #DD0000">'search'</span><span style="color: #007700">:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;You&nbsp;must&nbsp;sanitize&nbsp;any&nbsp;data&nbsp;that&nbsp;could&nbsp;be&nbsp;provided&nbsp;by&nbsp;a&nbsp;user.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;paterns&nbsp;below&nbsp;may&nbsp;not&nbsp;include&nbsp;all&nbsp;valid&nbsp;characters&nbsp;for&nbsp;your&nbsp;data<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;And&nbsp;the&nbsp;length&nbsp;limits&nbsp;below&nbsp;may&nbsp;be&nbsp;too&nbsp;short&nbsp;for&nbsp;your&nbsp;data<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$table_name&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">preg_replace</span><span style="color: #007700">(</span><span style="color: #DD0000">'/[^a-zA-Z_]/'</span><span style="color: #007700">,</span><span style="color: #DD0000">''</span><span style="color: #007700">,</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'table'</span><span style="color: #007700">]),</span><span style="color: #0000BB">0</span><span style="color: #007700">,</span><span style="color: #0000BB">20</span><span style="color: #007700">);&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$field_name&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">preg_replace</span><span style="color: #007700">(</span><span style="color: #DD0000">'/[^a-zA-Z_0-9]/'</span><span style="color: #007700">,</span><span style="color: #DD0000">''</span><span style="color: #007700">,</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'field'</span><span style="color: #007700">]),</span><span style="color: #0000BB">0</span><span style="color: #007700">,</span><span style="color: #0000BB">20</span><span style="color: #007700">);&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$value&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">preg_replace</span><span style="color: #007700">(</span><span style="color: #DD0000">'/[^a-zA-Z_\&nbsp;0-9]/'</span><span style="color: #007700">,</span><span style="color: #DD0000">''</span><span style="color: #007700">,</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #0000BB">$field_name</span><span style="color: #007700">]),</span><span style="color: #0000BB">0</span><span style="color: #007700">,</span><span style="color: #0000BB">255</span><span style="color: #007700">);&nbsp;&nbsp;<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"&lt;h2&gt;Search&nbsp;for&nbsp;[$table_name].[$field_name]=[$value]&lt;/h2&gt;"</span><span style="color: #007700">;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$db&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">database_schema</span><span style="color: #007700">();&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;database_schema&nbsp;has&nbsp;discovery&nbsp;methods&nbsp;allowing&nbsp;you&nbsp;load&nbsp;a&nbsp;class&nbsp;representing&nbsp;a&nbsp;table&nbsp;when&nbsp;given&nbsp;a&nbsp;string&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasTable</span><span style="color: #007700">(</span><span style="color: #0000BB">$table_name</span><span style="color: #007700">))&nbsp;{&nbsp;;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;two&nbsp;thirds&nbsp;of&nbsp;a&nbsp;model-view-controler&nbsp;are&nbsp;generated&nbsp;from&nbsp;the&nbsp;database&nbsp;by&nbsp;Druid&nbsp;in&nbsp;PHP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$table_class&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getClass</span><span style="color: #007700">(</span><span style="color: #0000BB">$table_name</span><span style="color: #007700">);&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;table_class&nbsp;is&nbsp;a&nbsp;model&nbsp;class&nbsp;for&nbsp;the&nbsp;table_name&nbsp;table.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$table_view&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getViewClass</span><span style="color: #007700">(</span><span style="color: #0000BB">$table_name</span><span style="color: #007700">);&nbsp;</span><span style="color: #FF8000">//&nbsp;table_view&nbsp;is&nbsp;a&nbsp;view&nbsp;class&nbsp;for&nbsp;the&nbsp;table_name&nbsp;table.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;You&nbsp;need&nbsp;to&nbsp;supply&nbsp;your&nbsp;own&nbsp;controler,&nbsp;or&nbsp;procedural&nbsp;code&nbsp;(like&nbsp;this&nbsp;file)&nbsp;to&nbsp;control&nbsp;these&nbsp;classes.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$table_class</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasField</span><span style="color: #007700">(</span><span style="color: #0000BB">$field_name</span><span style="color: #007700">))&nbsp;{&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;loadArrayKeyValueSearch()&nbsp;takes&nbsp;an&nbsp;array&nbsp;of&nbsp;fieldnames&nbsp;and&nbsp;search&nbsp;values&nbsp;as&nbsp;a&nbsp;parameter.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$searchTermArray&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #0000BB">$field_name&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$value</span><span style="color: #007700">);&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;loadArrayKeyValueSearch()&nbsp;queries&nbsp;the&nbsp;database&nbsp;and&nbsp;returns&nbsp;an&nbsp;array&nbsp;of&nbsp;model&nbsp;objects&nbsp;representing&nbsp;rows&nbsp;in&nbsp;the&nbsp;target&nbsp;table.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$results&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$table_class</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">loadArrayKeyValueSearch</span><span style="color: #007700">(</span><span style="color: #0000BB">$searchTermArray</span><span style="color: #007700">);&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">count</span><span style="color: #007700">(</span><span style="color: #0000BB">$results</span><span style="color: #007700">)==</span><span style="color: #0000BB">0</span><span style="color: #007700">)&nbsp;{&nbsp;echo&nbsp;</span><span style="color: #DD0000">'No&nbsp;matching&nbsp;values'</span><span style="color: #007700">;&nbsp;}&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach(</span><span style="color: #0000BB">$results&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$row</span><span style="color: #007700">)&nbsp;{&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$table_view</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setModel</span><span style="color: #007700">(</span><span style="color: #0000BB">$row</span><span style="color: #007700">);&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Tell&nbsp;the&nbsp;view&nbsp;which&nbsp;row&nbsp;to&nbsp;display.&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">echo&nbsp;</span><span style="color: #0000BB">$table_view</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getDetailsView</span><span style="color: #007700">();&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Tell&nbsp;the&nbsp;view&nbsp;how&nbsp;to&nbsp;display&nbsp;the&nbsp;row.&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Extend&nbsp;the&nbsp;{tablename}View&nbsp;classes&nbsp;to&nbsp;customize&nbsp;how&nbsp;records&nbsp;are&nbsp;displayed.&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">}<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;&nbsp;<br />
&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #DD0000">'table'</span><span style="color: #007700">:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$table_name&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">preg_replace</span><span style="color: #007700">(</span><span style="color: #DD0000">'/[^a-zA-Z_]/'</span><span style="color: #007700">,</span><span style="color: #DD0000">''</span><span style="color: #007700">,</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'table'</span><span style="color: #007700">]),</span><span style="color: #0000BB">0</span><span style="color: #007700">,</span><span style="color: #0000BB">20</span><span style="color: #007700">);&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;May&nbsp;not&nbsp;include&nbsp;all&nbsp;valid&nbsp;table&nbsp;name&nbsp;characters.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$db&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">database_schema</span><span style="color: #007700">();<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasTable</span><span style="color: #007700">(</span><span style="color: #0000BB">$table_name</span><span style="color: #007700">))&nbsp;{&nbsp;;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">'&lt;h2&gt;Distinct&nbsp;values&nbsp;in&nbsp;&nbsp;'</span><span style="color: #007700">.</span><span style="color: #0000BB">$table_name</span><span style="color: #007700">.</span><span style="color: #DD0000">'&lt;/h2&gt;'</span><span style="color: #007700">;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$table_class&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getClass</span><span style="color: #007700">(</span><span style="color: #0000BB">$table_name</span><span style="color: #007700">);<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Each&nbsp;field&nbsp;in&nbsp;the&nbsp;table&nbsp;with&nbsp;an&nbsp;index&nbsp;has&nbsp;a&nbsp;selectDistinct&nbsp;method&nbsp;that&nbsp;runs&nbsp;a&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;select&nbsp;count(*),&nbsp;fieldname&nbsp;from&nbsp;tablename&nbsp;group&nbsp;by&nbsp;fieldname&nbsp;query.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;These&nbsp;are&nbsp;directly&nbsp;accesible&nbsp;with&nbsp;selectDistinct{fieldname}&nbsp;methods,&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;and&nbsp;as&nbsp;shown&nbsp;here,&nbsp;with&nbsp;a&nbsp;generic&nbsp;keySelectDistinct($fieldname...)&nbsp;method.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$fieldarray&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$table_class</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">schemaHaveDistinct</span><span style="color: #007700">();&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;schemaHaveDistinct&nbsp;is&nbsp;a&nbsp;discovery&nbsp;method&nbsp;to&nbsp;find&nbsp;fields&nbsp;with&nbsp;selectDistinct&nbsp;methods.&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$fieldarray</span><span style="color: #007700">==</span><span style="color: #DD0000">''</span><span style="color: #007700">)&nbsp;{&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">'No&nbsp;values&nbsp;available.'</span><span style="color: #007700">;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach(</span><span style="color: #0000BB">$fieldarray&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$field</span><span style="color: #007700">)&nbsp;{&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">'&lt;h3&gt;Distinct&nbsp;values&nbsp;for&nbsp;'</span><span style="color: #007700">.</span><span style="color: #0000BB">$field</span><span style="color: #007700">.</span><span style="color: #DD0000">'&lt;/h3&gt;'</span><span style="color: #007700">;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$beginwith&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">''</span><span style="color: #007700">;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$link&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'index.php?display=search&amp;table='</span><span style="color: #007700">.</span><span style="color: #0000BB">$table_name</span><span style="color: #007700">.</span><span style="color: #DD0000">'&amp;field='</span><span style="color: #007700">.</span><span style="color: #0000BB">$field</span><span style="color: #007700">;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;&amp;{fieldname}={value}&nbsp;is&nbsp;appended&nbsp;by&nbsp;keySelectDistinct.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$endwith&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'&lt;BR&gt;'</span><span style="color: #007700">;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$includecount&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$orderbycsount&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #0000BB">$table_class</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">keySelectDistinct</span><span style="color: #007700">(</span><span style="color: #0000BB">$field</span><span style="color: #007700">,</span><span style="color: #0000BB">$beginwith</span><span style="color: #007700">,</span><span style="color: #0000BB">$link</span><span style="color: #007700">,</span><span style="color: #0000BB">$endwith</span><span style="color: #007700">,</span><span style="color: #0000BB">$includecount</span><span style="color: #007700">,</span><span style="color: #0000BB">$orderbycount</span><span style="color: #007700">);<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<br /></span>
<span style="color: #007700">}<br />
<br />
</span><span style="color: #0000BB">?&gt;</span>&nbsp;<br />
&lt;/body&gt;<br />
&lt;/html&gt;<br />
<br />
</code>


</body>
</html>
